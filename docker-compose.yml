version: '3.1'

networks:
  kafka:
    driver: bridge
  application:
    driver: bridge

services:
  zookeeper:
    build: ./zookeeper
    networks:
      - kafka

  kafka:
    build: ./kafka
    networks:
      - kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"

  producer:
    build: ./ruby-kafka-producer
    networks:
      - kafka
    depends_on:
      - kafka
    volumes:
      - "./LFS:/LFS"
    environment:
      KAFKA_URL: "kafka"
      KAFKA_TOPIC_NAME: "timer-log"
      KAFKA_PRODUCER_VERBOSE: "false"
      LISTEN_DIR: "/LFS"

  db:
    image: postgres
    networks:
      - application
    volumes:
      - ./rails-consumer-app/tmp/postgresql/data:/var/lib/postgresql/data
    environment: 
      POSTGRES_PASSWORD: "postgres"

  redis:
    image: redis
    volumes:
      - ./rails-consumer-app/tmp/redis/data:/var/lib/redis/data
    networks:
      - application

  app:
    build: ./rails-consumer-app
    networks:
      - application
    depends_on:
      - db
      - sidekiq
    volumes:
      - ./rails-consumer-app:/app
    ports: 
      - "3000:3000"
    environment:
      REDIS_URL: "redis://redis:6379"
      DATABASE_HOST: "db"
      DATABASE_USERNAME: "postgres"
      DATABASE_PASSWORD: "postgres"

  sidekiq:
    build: ./rails-consumer-app
    command: 'bundle exec sidekiq'
    networks:
      - kafka
      - application
    volumes:
      - ./rails-consumer-app:/app
    environment:
      REDIS_URL: "redis://redis:6379"
      KAFKA_URL: "kafka"
      KAFKA_TOPIC_NAME: "timer-log"
      KAFKA_GROUP_ID: "ruby-consumer"
      KAFKA_CONSUMER_VERBOSE: "false"
      DATABASE_HOST: "db"
      DATABASE_USERNAME: "postgres"
      DATABASE_PASSWORD: "postgres"
    depends_on:
      - kafka
      - db
      - redis
